# 数据库迁移说明

## 问题描述

在运行策略相关功能时，遇到以下错误：

```
sqlite3.OperationalError: no such column: strategy_portfolio_views.total_realized_pnl
```

## 原因分析

数据库表 `strategy_portfolio_views` 缺少以下列：
- `total_realized_pnl` - 已实现盈亏
- `gross_exposure` - 总敞口
- `net_exposure` - 净敞口

这些列在代码模型中已定义，但现有数据库表结构未包含这些列。

## 解决方案

已创建数据库迁移脚本 `python/scripts/migrate_db.py`，用于自动添加缺失的列。

### 执行迁移

在容器中执行：

```bash
docker compose exec backend uv run python scripts/migrate_db.py
```

或在本地执行：

```bash
cd python
uv run python scripts/migrate_db.py
```

### 迁移脚本功能

1. 检查列是否存在（避免重复添加）
2. 安全地添加缺失的列
3. 保留现有数据
4. 提供详细的日志输出

## 已添加的列

- `total_realized_pnl` (NUMERIC(20, 8), nullable)
- `gross_exposure` (NUMERIC(20, 8), nullable)
- `net_exposure` (NUMERIC(20, 8), nullable)

## 验证

迁移完成后，重启后端容器：

```bash
docker compose restart backend
```

然后测试相关 API 端点：
- `/api/v1/strategies/portfolio_summary`
- `/api/v1/strategies/holding_price_curve`

## 注意事项

- 迁移脚本是幂等的，可以安全地多次运行
- 迁移不会删除或修改现有数据
- 建议在迁移前备份数据库文件（`valuecell.db`）

## 未来改进

建议集成数据库迁移工具（如 Alembic）来管理更复杂的数据库架构变更。

