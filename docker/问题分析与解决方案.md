# 后端容器问题分析与解决方案

## 问题总结

根据后端容器日志分析，发现以下问题：

### 1. OpenSSL/TLS 连接错误 ⚠️

**错误信息**：
```
curl: (35) TLS connect error: error:00000000:invalid library (0):OPENSSL_internal:invalid library (0)
```

**影响**：
- yfinance 无法获取某些股票数据（如 ^IXIC, ^HSI）
- 部分 API 请求失败

**解决方案**：
- ✅ 已在 Dockerfile.backend 中添加完整的 OpenSSL 库支持
- 需要重新构建镜像：`docker compose build backend`

### 2. 网络连接问题 ⚠️

**错误信息**：
```
aiohttp.client_exceptions.ClientConnectorError: Cannot connect to host fapi.binance.com:443 ssl:default [None]
```

**影响**：
- 无法连接到 Binance API 获取市场数据
- 策略代理无法获取加密货币价格

**可能原因**：
- 容器网络配置问题
- 防火墙或代理设置
- DNS 解析问题

**解决方案**：
1. 检查容器网络配置
2. 确保容器可以访问外部网络
3. 如果使用代理，需要在 docker-compose.yml 中配置代理设置

### 3. API 密钥配置问题 ⚠️

**错误信息**：
```
Error code: 401 - Api key is invalid
```

**影响**：
- SiliconFlow API 调用失败
- LLM 功能无法使用

**解决方案**：
1. 检查 `.env` 文件中的 API 密钥配置
2. 确保 SiliconFlow API 密钥有效
3. 或者切换到其他已配置的 LLM 提供商（如 openrouter）

### 4. 500 内部服务器错误 ⚠️

**错误接口**：
- `/api/v1/strategies/portfolio_summary`
- `/api/v1/strategies/holding_price_curve`

**相关日志**：
```
WARNING - Failed to persist strategy portfolio snapshot for strategy-32b072e7897a494490d3397d2e8a162f
```

**可能原因**：
- 数据库连接问题
- 数据持久化逻辑错误
- 策略数据不完整

**解决方案**：
- 检查数据库连接
- 查看详细错误日志
- 确保策略数据已正确初始化

### 5. 警告信息（可忽略）ℹ️

**警告**：
```
warning: The package akracer==0.0.13 does not have an extra named py-mini-racer
```

**说明**：
- 这是依赖包的警告，不影响运行
- 可以忽略

## 修复步骤

### 步骤 1：重新构建后端镜像

```bash
# 停止当前容器
docker compose down

# 重新构建后端镜像（包含 OpenSSL 修复）
docker compose build backend

# 启动服务
docker compose up -d
```

### 步骤 2：检查网络连接

```bash
# 进入后端容器
docker compose exec backend bash

# 测试网络连接
curl -I https://fapi.binance.com
curl -I https://api.siliconflow.cn
```

### 步骤 3：配置 API 密钥

编辑 `.env` 文件，确保包含有效的 API 密钥：

```bash
# SiliconFlow API 密钥
SILICONFLOW_API_KEY=your-api-key-here

# 或者使用其他提供商
OPENROUTER_API_KEY=your-api-key-here
GOOGLE_API_KEY=your-api-key-here
```

### 步骤 4：验证修复

```bash
# 查看日志
docker compose logs -f backend

# 检查健康状态
curl http://localhost:8000/api/v1/healthz
```

## 网络配置建议

如果遇到网络连接问题，可以在 `docker-compose.yml` 中添加网络配置：

```yaml
services:
  backend:
    # ... 其他配置 ...
    network_mode: bridge
    dns:
      - 8.8.8.8
      - 8.8.4.4
    # 如果需要代理
    # environment:
    #   - HTTP_PROXY=http://proxy:port
    #   - HTTPS_PROXY=http://proxy:port
```

## 监控建议

定期检查以下指标：
1. 容器健康状态：`docker compose ps`
2. 错误日志：`docker compose logs backend | grep ERROR`
3. API 响应时间：监控 `/api/v1/healthz` 端点
4. 网络连接：测试外部 API 连接

## 联系支持

如果问题持续存在，请提供：
1. 完整的容器日志：`docker compose logs backend > backend.log`
2. 网络测试结果
3. 环境配置信息

